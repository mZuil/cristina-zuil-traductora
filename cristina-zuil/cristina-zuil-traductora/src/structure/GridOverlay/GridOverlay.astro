---
import './GridOverlay.css';
---

<div id="grid-overlay" class="grid-overlay hidden"></div>

<script>
  // Grid overlay toggle component with keyboard shortcut
  // Press Cmd+Shift+G (Mac) or Ctrl+Shift+G (Windows) to toggle

  (function() {
    // Wait for DOM to be ready
    function init() {
      let isVisible = false;
      const overlay = document.getElementById('grid-overlay');
      
      if (!overlay) {
        console.warn('GridOverlay: overlay element not found');
        return;
      }

      // Calculate grid overlay based on actual CustomContainer elements
      function updateGridOverlay() {
        const rootStyle = getComputedStyle(document.documentElement);
        const containers = document.querySelectorAll('.custom-container');
        
        if (containers.length === 0) {
          overlay.innerHTML = '';
          return;
        }
        
        let overlayHTML = '';
        
        // Helper to convert rem to px
        function remToPx(remStr: string): number {
          if (remStr.includes('rem')) {
            const remValue = parseFloat(remStr);
            return remValue * parseFloat(getComputedStyle(document.documentElement).fontSize);
          }
          return parseFloat(remStr);
        }
        
        // Process each container
        containers.forEach((container) => {
          const el = container as HTMLElement;
          const rect = el.getBoundingClientRect();
          const style = window.getComputedStyle(el);
          
          // Get breakpoints from CSS variables
          const smBreakpoint = parseFloat(rootStyle.getPropertyValue('--breakpoint-sm').trim()) || 640;
          const mdBreakpoint = parseFloat(rootStyle.getPropertyValue('--breakpoint-md').trim()) || 768;
          const lgBreakpoint = parseFloat(rootStyle.getPropertyValue('--breakpoint-lg').trim()) || 1024;
          
          // Determine columns based on container width
          let columns = parseInt(rootStyle.getPropertyValue('--grid-columns-sm').trim()) || 4;
          let gap = rootStyle.getPropertyValue('--grid-gap-sm').trim() || '1rem';
          let padding = rootStyle.getPropertyValue('--container-padding-sm').trim() || '1rem';
          
          if (rect.width >= lgBreakpoint) {
            columns = parseInt(rootStyle.getPropertyValue('--grid-columns-lg').trim()) || 12;
            gap = rootStyle.getPropertyValue('--grid-gap-lg').trim() || '2rem';
            padding = rootStyle.getPropertyValue('--container-padding-lg').trim() || '3rem';
          } else if (rect.width >= mdBreakpoint) {
            columns = parseInt(rootStyle.getPropertyValue('--grid-columns-md').trim()) || 8;
            gap = rootStyle.getPropertyValue('--grid-gap-md').trim() || '1.5rem';
            padding = rootStyle.getPropertyValue('--container-padding-md').trim() || '2rem';
          }
          
          // Convert to pixels
          const gapValue = remToPx(gap);
          const paddingValue = remToPx(padding);
          
          // Calculate column width
          const totalGaps = (columns - 1) * gapValue;
          const availableWidth = rect.width - (paddingValue * 2);
          const columnWidth = (availableWidth - totalGaps) / columns;
          
          // Create overlay for this container
          // Use viewport-relative positions since overlay is position: fixed
          const containerStartX = rect.left;
          const containerStartY = rect.top;
          
          // Draw columns
          for (let i = 0; i < columns; i++) {
            // Calculate column position
            const columnLeft = containerStartX + paddingValue + (i * (columnWidth + gapValue));
            const columnRight = columnLeft + columnWidth;
            
            // Column line (left edge)
            overlayHTML += `<div class="grid-line" style="left: ${columnLeft}px; top: ${containerStartY}px; height: ${rect.height}px;"></div>`;
            
            // Column number (centered in column)
            const numberLeft = columnLeft + columnWidth / 2;
            overlayHTML += `<div class="grid-column-number" style="left: ${numberLeft}px; top: ${containerStartY + 10}px;">${i + 1}</div>`;
            
            // Gap visualization (between columns, except after last column)
            if (i < columns - 1 && gapValue > 0) {
              overlayHTML += `<div class="grid-gap" style="left: ${columnRight}px; width: ${gapValue}px; top: ${containerStartY}px; height: ${rect.height}px;"></div>`;
            }
          }
          
          // Right edge line (last column)
          const lastColumnLeft = containerStartX + paddingValue + ((columns - 1) * (columnWidth + gapValue));
          const lastColumnRight = lastColumnLeft + columnWidth;
          overlayHTML += `<div class="grid-line" style="left: ${lastColumnRight}px; top: ${containerStartY}px; height: ${rect.height}px;"></div>`;
        });
        
        overlay.innerHTML = overlayHTML;
      }

      function toggleGrid() {
        isVisible = !isVisible;
        overlay.classList.toggle('hidden', !isVisible);
        
        console.log('Grid overlay toggled:', isVisible ? 'ON' : 'OFF');
        
        if (isVisible) {
          updateGridOverlay();
          const updateHandler = () => {
            requestAnimationFrame(updateGridOverlay);
          };
          window.addEventListener('resize', updateHandler);
          window.addEventListener('scroll', updateHandler, true);
          
          // Store handlers for cleanup
          overlay._resizeHandler = updateHandler;
          overlay._scrollHandler = updateHandler;
        } else {
          const resizeHandler = overlay._resizeHandler;
          const scrollHandler = overlay._scrollHandler;
          if (resizeHandler) window.removeEventListener('resize', resizeHandler);
          if (scrollHandler) window.removeEventListener('scroll', scrollHandler, true);
        }
      }

      // Keyboard shortcut: Cmd+Shift+G (Mac) or Ctrl+Shift+G (Windows)
      document.addEventListener('keydown', (e) => {
        const isMac = navigator.platform.toUpperCase().indexOf('MAC') >= 0 || 
                      navigator.userAgent.toUpperCase().indexOf('MAC') >= 0;
        const modifier = isMac ? e.metaKey : e.ctrlKey;
        
        if (modifier && e.shiftKey && (e.key === 'G' || e.key === 'g')) {
          e.preventDefault();
          e.stopPropagation();
          toggleGrid();
        }
      });
      
      console.log('GridOverlay initialized. Press Ctrl+Shift+G (Windows) or Cmd+Shift+G (Mac) to toggle.');
    }

    // Initialize when DOM is ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', init);
    } else {
      init();
    }
  })();
</script>
