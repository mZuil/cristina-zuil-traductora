---
import Layout from '../layouts/Layout.astro';
import { 
  i18nConfig, 
  getLocalizedUrl, 
  fetchPagesByLocale,
  fetchBooksByLocale,
  fetchArticlesByLocale,
  isHomePage 
} from '../config/i18n.js';

// Import templates
import DefaultPage from '../templates/DefaultPage.astro';
import ArchiveBooks from '../templates/archive/ArchiveBooks.astro';
import ArchiveArticles from '../templates/archive/ArchiveArticles.astro';

export async function getStaticPaths() {
  const pages = await fetchPagesByLocale(i18nConfig.defaultLocale);
  
  if (pages.length === 0) {
    console.warn(`No pages found for default locale: ${i18nConfig.defaultLocale}`);
    return [];
  }
  
  const validPages = pages.filter((page: any) => {
    if (!page?.slug || isHomePage(page)) {
      if (isHomePage(page)) {
        console.log('Excluding homepage from [slug] routes');
      }
      return false;
    }
    return true;
  });
  
  console.log('Valid pages (excluding home):', validPages.length);
  
  // Fetch template data for each page
  const paths: Array<{
    params: { slug: string };
    props: { page: any; templateData?: any };
  }> = [];
  
  for (const page of validPages) {
    let templateData = null;
    
    // Fetch data based on template type
    if (page.template === 'archive-books') {
      // Check if page has a category field, otherwise fetch all
      const category = page.bookCategory || null;
      templateData = await fetchBooksByLocale(i18nConfig.defaultLocale, category);
    } else if (page.template === 'archive-articles') {
      templateData = await fetchArticlesByLocale(i18nConfig.defaultLocale);
    }
    
    paths.push({
      params: { slug: page.slug },
      props: { page, templateData },
    });
  }
  
  return paths;
}

interface Props {
  page: any;
  templateData?: any;
}

const { page, templateData } = Astro.props as Props;
const { title, content, slug, localizations, template } = page;

const getLocaleLabel = (loc: string) => {
  return i18nConfig.localeLabels[loc as keyof typeof i18nConfig.localeLabels] || loc.toUpperCase();
};
---

<Layout title={title}>
  <main>
    <nav class="language-switcher">
      <a href={`/${slug}`} class="active">
        {getLocaleLabel(i18nConfig.defaultLocale)}
      </a>
      {localizations?.map((localization: any) => {
        const locale = localization.locale;
        const localizedSlug = localization.slug;
        return (
          <a href={getLocalizedUrl(localizedSlug, locale)}>
            {getLocaleLabel(locale)}
          </a>
        );
      })}
    </nav>
    
    {/* Render based on template type */}
    {template === 'archive-books' && templateData ? (
      <ArchiveBooks 
        items={templateData}
        title={title}
        description={content}
        archiveSlug={slug}
        category={page.bookCategory || ''}
      />
    ) : template === 'archive-articles' && templateData ? (
      <ArchiveArticles 
        items={templateData}
        title={title}
        description={content}
        archiveSlug={slug}
      />
    ) : (
      <DefaultPage page={page} />
    )}
  </main>
</Layout>