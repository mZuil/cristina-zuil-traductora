---
import Layout from '../../layouts/Layout.astro';
import { 
  i18nConfig, 
  getLocalizedUrl, 
  fetchPagesByLocale,
  fetchBooksByLocale,
  fetchArticlesByLocale,
  getNonDefaultLocales,
  isHomePage 
} from '../../config/i18n.js';

import DefaultPage from '../../templates/DefaultPage.astro';
import ArchiveBooks from '../../templates/archive/ArchiveBooks.astro';
import ArchiveArticles from '../../templates/archive/ArchiveArticles.astro';

export async function getStaticPaths() {
  const nonDefaultLocales = getNonDefaultLocales();
  const allPaths: Array<{
    params: { locale: string; slug: string };
    props: { page: any; locale: string; templateData?: any };
  }> = [];
  
  for (const locale of nonDefaultLocales) {
    const pages = await fetchPagesByLocale(locale);
    
    const validPages = pages.filter((page: any) => {
      if (!page?.slug || isHomePage(page)) {
        return false;
      }
      return true;
    });
    
    for (const page of validPages) {
      let templateData = null;
      
      if (page.template === 'archive-books') {
        const category = page.bookCategory || null;
        templateData = await fetchBooksByLocale(locale, category);
      } else if (page.template === 'archive-articles') {
        templateData = await fetchArticlesByLocale(locale);
      }
      
      allPaths.push({
        params: { 
          locale,
          slug: page.slug 
        },
        props: { page, locale, templateData },
      });
    }
  }
  
  return allPaths;
}

interface Props {
  page: any;
  locale: string;
  templateData?: any;
}

const { page, locale, templateData } = Astro.props as Props;
const { title, content, slug, localizations, template } = page;

const getLocaleLabel = (loc: string) => {
  return i18nConfig.localeLabels[loc as keyof typeof i18nConfig.localeLabels] || loc.toUpperCase();
};

// Determine content type based on template
const contentType = template === 'archive-books' || template === 'archive-articles' 
  ? 'CollectionPage' 
  : 'WebPage';
---

<Layout 
  content={page}
  locale={locale}
  contentType={contentType}
>
  <main>
    <nav class="language-switcher">
      {localizations?.map((localization: any) => {
        const loc = localization.locale;
        const localizedSlug = localization.slug;
        
        return (
          <a href={getLocalizedUrl(localizedSlug, loc)}>
            {getLocaleLabel(loc)}
          </a>
        );
      })}
      <a href={`/${locale}/${slug}`} class="active">
        {getLocaleLabel(locale)}
      </a>
    </nav>
    
    {template === 'archive-books' && templateData ? (
      <ArchiveBooks 
        items={templateData}
        title={title}
        description={content}
        locale={locale}
        archiveSlug={slug}
        category={page.bookCategory || ''}
      />
    ) : template === 'archive-articles' && templateData ? (
      <ArchiveArticles 
        items={templateData}
        title={title}
        description={content}
        locale={locale}
        archiveSlug={slug}
      />
    ) : (
      <DefaultPage page={page} />
    )}
  </main>
</Layout>